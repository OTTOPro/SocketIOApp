<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/theme/material.min.css">
    <script>
        const socket = io();

        let roomId; // Variable pour stocker l'identifiant de la salle
        function toggleRoom() {
            if (roomId) {
                socket.emit('leaveRoom', roomId);
                roomId = null;
                document.getElementById("roomButton").innerText = "Joindre une salle";
            } else {
                roomId = prompt("Entrez l'id de la salle:");
                if (roomId) { // Vérifier si un identifiant de salle a été saisi
                    socket.emit('joinRoom', roomId);
                    document.getElementById("roomButton").innerText = "Quitter une salle";
                }
            }
        }
    </script>
     <style>
        h1, h2 {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>Collaboration en temps réel</h1> 
    <h2>Avec Socket.IO et Node.js</h2>
    <div>
        <button id="roomButton" onclick="toggleRoom()">Joindre une salle</button>
    </div>
    <div id="clientId"></div>
    <textarea id="editor"></textarea>

    <!-- Inclure le fichier JavaScript de CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.js"></script>
    <!-- Inclure le mode JavaScript pour la coloration syntaxique -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/mode/javascript/javascript.min.js"></script>

    <script>
        var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
            lineNumbers: true,
            mode: "javascript",
            theme: "material"
        });
    
        var ignoreChangeEvent = false; // On ajoute cette variable pour suivre l'état de l'événement
    
        editor.on("change", function () {
            if (!ignoreChangeEvent) { // On verifie si l'événement doit être ignoré
                const code = editor.getValue();
                socket.emit('codeChange', { code: code, roomId: roomId });
            }
        });
        
        socket.on('codeChange', function (data) {
            if (socket.id !== data.senderId && data.roomId === roomId || !data.roomId) {
                ignoreChangeEvent = true; // on desactive temporairement la gestion des événements
                editor.setValue(data.code);
                ignoreChangeEvent = false; // on reactive la gestion des événements après la mise à jour
            }
        });

        socket.on('connect', function() {
            document.getElementById('clientId').innerText = 'Votre ID: ' + socket.id;
        });
    </script>
    

</body>

</html>